<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ä»Šæ²»å¸‚ å½“ç•ªåŒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: sans-serif;
        /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
        margin: 0; 
      }
      /* ã‚¿ã‚¤ãƒˆãƒ«ã¯ä¸è¦ */
      h2 {
        display: none;
      }
      #calendar {
        /* æœ€å¤§å¹…ã‚’è¨­å®šã›ãšã€ç”»é¢å¹…ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
        max-width: none; 
        margin: 0;
        height: auto;
      }
      /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯ä¸è¦ */
      #filter {
        display: none;
      }
      
      /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã¯æ®‹ã—ã¦ãŠã */
      @media (max-width: 600px) {
        #calendar {
          width: 100%;
          font-size: 12px;
        }
      }
      
      /* å°åˆ·æ™‚ã®è¨­å®šã‚’ç¶­æŒ */
      @media print {
        body {
          margin: 0;
          width: 100%;
          height: 100vh;
          overflow: hidden; 
          font-size: 8pt; 
        }
        /* å°åˆ·æ™‚ã‚‚ä¸è¦ */
        #filter,
        h2 {
          display: none;
        }
        #calendar {
          zoom: 100%;
          padding: 5px; 
        }
        .fc-day-today {
          background: none !important;
          border: none !important;
        }
        @page {
            size: A4 landscape;
            margin: 0.3cm; 
        }
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚‚ä¸è¦ */
        .fc-toolbar {
            display: none;
        }
        .fc-daygrid-body,
        .fc-scrollgrid-sync-table {
            height: 100%;
        }
        .fc-daygrid-day-frame {
            min-height: 0 !important;
        }
        .fc-daygrid-event-harness {
            margin-bottom: 0px; 
        }
      }
    </style>
  </head>
  <body>
    <h2>ğŸ“… ä»Šæ²»å¸‚ å½“ç•ªåŒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <div id="filter">
      <label for="hospitalSelect">ğŸ¥ ç—…é™¢ã§çµã‚Šè¾¼ã¿ï¼š</label>
      <select id="hospitalSelect">
        <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
      </select>
    </div>
    <div id="calendar"></div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
    <script>
      dayjs.extend(dayjs_plugin_utc);
      dayjs.extend(dayjs_plugin_timezone);

      const url = "calendar.csv";
      const islandHospitals = [
        "ã—ã®ã–ãæ•´å½¢å¤–ç§‘",
        "ã¯ã‹ãŸå¤–ç§‘èƒƒè…¸ç§‘",
        "å–œå¤šå¶‹è¨ºç™‚æ‰€",
        "æ–è—¤ã‚¯ãƒªãƒ‹ãƒƒã‚¯",
        "å¤§ä¸‰å³¶ä¸­å¤®ç—…é™¢",
        "ç‰‡å±±åŒ»é™¢",
        "æœ‰æ´¥ã‚€ã‚‰ã‹ã¿ã‚¯ãƒªãƒ‹ãƒƒã‚¯",
      ];

      function getEmoji(medical, hospital) {
        if (medical === "æ•´å½¢å¤–ç§‘") return "ğŸ©¼";
        if (medical === "å°å…ç§‘") return "ğŸ§’";
        if (medical === "å†…ç§‘") return "ğŸ©º";
        if (islandHospitals.includes(hospital)) return "ğŸï¸";
        return "ğŸ¥";
      }

      function getColor(medical, hospital) {
        if (medical === "æ•´å½¢å¤–ç§‘") return "#3f51b5";
        if (medical === "å°å…ç§‘") return "#e91e63";
        if (medical === "å†…ç§‘") return "#4caf50";
        if (islandHospitals.includes(hospital)) return "#ffb300";
        return "#607d8b";
      }

      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          const data = results.data;

          // ç—…é™¢åä¸€è¦§ã‚’æŠ½å‡ºï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã¯ç„¡ããªã£ãŸãŒã€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¯æ®‹ã™ï¼‰
          const hospitals = [...new Set(data.map((row) => row.name))].sort();
          const select = document.getElementById("hospitalSelect");
          hospitals.forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
          });

          // ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆï¼ˆé †ç•ªä¿æŒï¼‰
          const allEvents = data.map((row, index) => {
            const emoji = getEmoji(row.medical, row.name);
            return {
              title: `${emoji} ${row.name} (${row.time})`,
              start: row.date,
              extendedProps: {
                medical: row.medical,
                hospital: row.name,
                time: row.time,
                week: row.week,
              },
              color: getColor(row.medical, row.name),
              order: index,
            };
          });

          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–
          const calendar = new FullCalendar.Calendar(
            document.getElementById("calendar"),
            {
              initialView: "dayGridMonth",
              locale: "ja",
              events: allEvents,
              eventOrder: "order",
              height: 'auto', 
              
              // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤º
              headerToolbar: false,
              
              dayCellDidMount: function (info) {
                const today = dayjs().tz("Asia/Tokyo").format("YYYY-MM-DD");
                const cellDate = dayjs(info.date)
                  .tz("Asia/Tokyo")
                  .format("YYYY-MM-DD");

                // ä»Šæ—¥ã®å¼·èª¿è¡¨ç¤ºï¼ˆå°åˆ·æ™‚ã¯CSSã§æ¶ˆãˆã‚‹ï¼‰
                if (cellDate === today) {
                  info.el.style.backgroundColor = "#fffbe6";
                  info.el.style.border = "2px solid #ff9900";
                }

                // åœŸæ›œæ—¥: è–„ã„é’
                if (info.date.getDay() === 6) {
                  info.el.style.backgroundColor = "#e6f7ff";
                }

                // æ—¥æ›œæ—¥: è–„ã„èµ¤
                if (info.date.getDay() === 0) {
                  info.el.style.backgroundColor = "#ffe6e6";
                }
              },
              eventDidMount: function (info) {
                const { medical, time, week } = info.event.extendedProps;
                info.el.setAttribute(
                  "title",
                  `è¨ºç™‚ç§‘: ${medical}\næ™‚é–“å¸¯: ${time}\næ›œæ—¥: ${week}`
                );
              },
            }
          );
          calendar.render();

          // ç—…é™¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆæ©Ÿèƒ½ã¨ã—ã¦ã¯ä¸è¦ã ãŒã€ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚æ®‹ã—ã¦ãŠãï¼‰
          select.addEventListener("change", () => {
            const selected = select.value;
            const filtered =
              selected === "all"
                ? allEvents
                : allEvents.filter(
                    (e) => e.extendedProps.hospital === selected
                  );
            calendar.removeAllEvents();
            calendar.addEventSource(filtered);
          });
        },
      });
    </script>
  </body>
</html>
