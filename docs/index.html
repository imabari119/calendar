<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ä»Šæ²»å¸‚ å½“ç•ªåŒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      h2 {
        text-align: center;
      }
      #calendar {
        max-width: 900px;
        margin: auto;
        height: auto;
      }
      #filter {
        margin: 20px auto;
        text-align: center;
      }
      select {
        padding: 6px;
        font-size: 14px;
      }
      @media (max-width: 600px) {
        #calendar {
          width: 100%;
          font-size: 12px;
        }
        select {
          width: 90%;
        }
      }
      @media print {
        body {
          margin: 0;
        }
        #filter,
        h2 {
          display: none;
        }
        #calendar {
          zoom: 80%;
        }
      }
    </style>
  </head>
  <body>
    <h2>ğŸ“… ä»Šæ²»å¸‚ å½“ç•ªåŒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <div id="filter">
      <label for="hospitalSelect">ğŸ¥ ç—…é™¢ã§çµã‚Šè¾¼ã¿ï¼š</label>
      <select id="hospitalSelect">
        <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
      </select>
    </div>
    <div id="calendar"></div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
      const url = "calendar.csv";
      const islandHospitals = [
        "ã—ã®ã–ãæ•´å½¢å¤–ç§‘",
        "ã¯ã‹ãŸå¤–ç§‘èƒƒè…¸ç§‘",
        "å–œå¤šå¶‹è¨ºç™‚æ‰€",
        "æ–è—¤ã‚¯ãƒªãƒ‹ãƒƒã‚¯",
        "å¤§ä¸‰å³¶ä¸­å¤®ç—…é™¢",
        "ç‰‡å±±åŒ»é™¢",
        "æœ‰æ´¥ã‚€ã‚‰ã‹ã¿ã‚¯ãƒªãƒ‹ãƒƒã‚¯",
      ];

      function getEmoji(medical, hospital) {
        if (medical === "å°å…ç§‘") return "ğŸ§’";
        if (medical === "å†…ç§‘") return "ğŸ©º";
        if (islandHospitals.includes(hospital)) return "ğŸï¸";
        return "ğŸ¥";
      }

      function getColor(medical, hospital) {
        if (medical === "å°å…ç§‘") return "#e91e63";
        if (medical === "å†…ç§‘") return "#4caf50";
        if (islandHospitals.includes(hospital)) return "#ffb300";
        return "#607d8b";
      }

      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          const data = results.data;

          // ç—…é™¢åä¸€è¦§ã‚’æŠ½å‡º
          const hospitals = [...new Set(data.map((row) => row.name))].sort();
          const select = document.getElementById("hospitalSelect");
          hospitals.forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
          });

          // ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆï¼ˆé †ç•ªä¿æŒï¼‰
          const allEvents = data.map((row, index) => {
            const emoji = getEmoji(row.medical, row.name);
            return {
              title: `${emoji} ${row.name} (${row.time})`,
              start: row.date,
              extendedProps: {
                medical: row.medical,
                hospital: row.name,
                time: row.time,
              },
              color: getColor(row.medical, row.name),
              order: index,
            };
          });

          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–
          const calendar = new FullCalendar.Calendar(
            document.getElementById("calendar"),
            {
              initialView: "dayGridMonth",
              locale: "ja",
              events: allEvents,
              eventOrder: "order",
              headerToolbar: {
                left: "prev,next today",
                center: "title",
                right: "dayGridMonth,listWeek",
              },
                buttonText: {
                today: "ä»Šæ—¥",
                month: "æœˆè¡¨ç¤º",
                list: "ä¸€è¦§"
              },
              dayCellDidMount: function (info) {
                const today = new Date().toISOString().split("T")[0];
                if (info.date.toISOString().split("T")[0] === today) {
                  info.el.style.backgroundColor = "#fffbe6";
                  info.el.style.border = "2px solid #ff9900";
                }
              },
              eventDidMount: function (info) {
                const { medical, time } = info.event.extendedProps;
                info.el.setAttribute("title", `æ›œæ—¥: ${week}\nè¨ºç™‚ç§‘: ${medical}\næ™‚é–“å¸¯: ${time}`);
              },
            }
          );
          calendar.render();

          // ç—…é™¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
          select.addEventListener("change", () => {
            const selected = select.value;
            const filtered =
              selected === "all"
                ? allEvents
                : allEvents.filter((e) => e.extendedProps.hospital === selected);
            calendar.removeAllEvents();
            calendar.addEventSource(filtered);
          });
        },
      });
    </script>
  </body>
</html>
