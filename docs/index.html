<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ä»Šæ²»å¸‚ å½“ç•ªåŒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      h2 {
        text-align: center;
      }
      #calendar {
        max-width: 900px;
        margin: auto;
        height: auto;
      }
      #filter {
        margin: 20px auto;
        text-align: center;
      }
      select {
        padding: 6px;
        font-size: 14px;
      }
      @media (max-width: 600px) {
        #calendar {
          width: 100%;
          font-size: 12px;
        }
        select {
          width: 90%;
        }
      }
      @media print {
        body {
          margin: 0;
          width: 100%;
          height: 100vh;
          overflow: hidden;
        }
        
        /* ğŸ’¡ ä¿®æ­£ç®‡æ‰€1: <h2> (ã‚¿ã‚¤ãƒˆãƒ«) ã¨ #filter (çµã‚Šè¾¼ã¿) ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        #filter,
        h2 {
          display: none;
        }
        
        #calendar {
          /* A4æ¨ªã§æœ€å¤§åŒ– */
          zoom: 100%;
          padding: 10px;
        }
        /* å°åˆ·æ™‚ã¯ä»Šæ—¥ã®å¼·èª¿ã‚’ãƒªã‚»ãƒƒãƒˆ */
        .fc-day-today {
          background: none !important;
          border: none !important;
        }
        /* A4æ¨ªã®ç´™é¢å…¨ä½“ã‚’ä½¿ã†ãŸã‚ã®è¨­å®š */
        @page {
            size: A4 landscape;
            margin: 0.5cm;
        }
        
        /* ğŸ’¡ ä¿®æ­£ç®‡æ‰€2: å¹´æœˆ(`.fc-toolbar-title`)ä»¥å¤–ã®ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        /* prev/next/todayãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
        .fc-button-group {
            display: none !important;
        }
        /* å¹´æœˆã‚¿ã‚¤ãƒˆãƒ«(`.fc-toolbar-title`)ã‚’å›²ã‚€è¦ç´ ã®ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ */
        .fc-header-toolbar {
            justify-content: center !important; /* å¹´æœˆã‚’ä¸­å¤®å¯„ã› */
            margin-bottom: 0.5em !important; /* å¹´æœˆã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é–“ã«å°‘ã—ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
        }
        /* å¹´æœˆã‚¿ã‚¤ãƒˆãƒ«ã ã‘ã‚’æ®‹ã™ */
        .fc-header-toolbar .fc-toolbar-chunk:first-child,
        .fc-header-toolbar .fc-toolbar-chunk:last-child {
            visibility: hidden !important; /* è¦ç´ ã®é ˜åŸŸã¯æ®‹ã—ã¦ä¸­èº«ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
            width: 0 !important; /* é ˜åŸŸè‡ªä½“ã‚‚æ¶ˆã™ */
            padding: 0 !important;
        }
        /* å¹´æœˆã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤§ããã—ã€å¼·èª¿ã™ã‚‹ */
        .fc-toolbar-title {
            font-size: 1.5em !important; 
            margin: 0 auto !important;
        }
      }
    </style>
  </head>
  <body>
    <h2>ğŸ“… ä»Šæ²»å¸‚ å½“ç•ªåŒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <div id="filter">
      <label for="hospitalSelect">ğŸ¥ ç—…é™¢ã§çµã‚Šè¾¼ã¿ï¼š</label>
      <select id="hospitalSelect">
        <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
      </select>
    </div>
    <div id="calendar"></div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
    <script>
      dayjs.extend(dayjs_plugin_utc);
      dayjs.extend(dayjs_plugin_timezone);

      const url = "calendar.csv";
      const islandHospitals = [
        "ã—ã®ã–ãæ•´å½¢å¤–ç§‘",
        "ã¯ã‹ãŸå¤–ç§‘èƒƒè…¸ç§‘",
        "å–œå¤šå¶‹è¨ºç™‚æ‰€",
        "æ–è—¤ã‚¯ãƒªãƒ‹ãƒƒã‚¯",
        "å¤§ä¸‰å³¶ä¸­å¤®ç—…é™¢",
        "ç‰‡å±±åŒ»é™¢",
        "æœ‰æ´¥ã‚€ã‚‰ã‹ã¿ã‚¯ãƒªãƒ‹ãƒƒã‚¯",
      ];

      function getEmoji(medical, hospital) {
        if (medical === "æ•´å½¢å¤–ç§‘") return "ğŸ©¼";
        if (medical === "å°å…ç§‘") return "ğŸ§’";
        if (medical === "å†…ç§‘") return "ğŸ©º";
        if (islandHospitals.includes(hospital)) return "ğŸï¸";
        return "ğŸ¥";
      }

      function getColor(medical, hospital) {
        if (medical === "æ•´å½¢å¤–ç§‘") return "#3f51b5";
        if (medical === "å°å…ç§‘") return "#e91e63";
        if (medical === "å†…ç§‘") return "#4caf50";
        if (islandHospitals.includes(hospital)) return "#ffb300";
        return "#607d8b";
      }

      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          const data = results.data;

          // ç—…é™¢åä¸€è¦§ã‚’æŠ½å‡º
          const hospitals = [...new Set(data.map((row) => row.name))].sort();
          const select = document.getElementById("hospitalSelect");
          hospitals.forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
          });

          // ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆï¼ˆé †ç•ªä¿æŒï¼‰
          const allEvents = data.map((row, index) => {
            const emoji = getEmoji(row.medical, row.name);
            return {
              title: `${emoji} ${row.name} (${row.time})`,
              start: row.date,
              extendedProps: {
                medical: row.medical,
                hospital: row.name,
                time: row.time,
                week: row.week,
              },
              color: getColor(row.medical, row.name),
              order: index,
            };
          });

          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–
          const calendar = new FullCalendar.Calendar(
            document.getElementById("calendar"),
            {
              initialView: "dayGridMonth",
              locale: "ja",
              events: allEvents,
              eventOrder: "order",
              // å°åˆ·ãƒ»è¡¨ç¤ºæ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘åˆ¶ã®ãŸã‚é«˜ã•ã‚’è‡ªå‹•èª¿æ•´
              height: 'auto', 
              headerToolbar: {
                left: "prev,next today",
                center: "title",
                right: "dayGridMonth,listWeek",
              },
              buttonText: {
                today: "ä»Šæ—¥",
                month: "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼",
                list: "ä¸€è¦§",
              },
              dayCellDidMount: function (info) {
                const today = dayjs().tz("Asia/Tokyo").format("YYYY-MM-DD");
                const cellDate = dayjs(info.date)
                  .tz("Asia/Tokyo")
                  .format("YYYY-MM-DD");

                // ä»Šæ—¥ã®å¼·èª¿è¡¨ç¤ºï¼ˆå°åˆ·æ™‚ã¯CSSã§æ¶ˆãˆã‚‹ï¼‰
                if (cellDate === today) {
                  info.el.style.backgroundColor = "#fffbe6";
                  info.el.style.border = "2px solid #ff9900";
                }

                // åœŸæ›œæ—¥: è–„ã„é’
                if (info.date.getDay() === 6) {
                  info.el.style.backgroundColor = "#e6f7ff";
                }

                // æ—¥æ›œæ—¥: è–„ã„èµ¤
                if (info.date.getDay() === 0) {
                  info.el.style.backgroundColor = "#ffe6e6";
                }
              },
              eventDidMount: function (info) {
                const { medical, time, week } = info.event.extendedProps;
                info.el.setAttribute(
                  "title",
                  `è¨ºç™‚ç§‘: ${medical}\næ™‚é–“å¸¯: ${time}\næ›œæ—¥: ${week}`
                );
              },
            }
          );
          calendar.render();

          // ç—…é™¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
          select.addEventListener("change", () => {
            const selected = select.value;
            const filtered =
              selected === "all"
                ? allEvents
                : allEvents.filter(
                    (e) => e.extendedProps.hospital === selected
                  );
            calendar.removeAllEvents();
            calendar.addEventSource(filtered);
          });
        },
      });
    </script>
  </body>
</html>
